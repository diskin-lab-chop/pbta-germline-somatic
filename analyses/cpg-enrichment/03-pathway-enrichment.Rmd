---
title: 'Pathway PLP enrichment analyses'
output: 
  html_document:
  toc: TRUE
toc_float: TRUE
author: Ryan Corbett
date: "2023"
---

This script summarizes germline P-LP variant enrichment at the pathway level in the PBTA cohort relative to Penn Med Biobank (PMBB) and gnomAD control cohorts. 
  
Load packages and set directories

```{r load libraries}
library(data.table)
library(tidyverse)
library(ggplot2)
library(ggpubr)

root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
setwd(root_dir)

data_dir <- file.path(root_dir, "data")
analysis_dir <- file.path(root_dir, "analyses", "cpg-enrichment")
input_dir <- file.path(analysis_dir, "input")
results_dir <- file.path(analysis_dir, "results")
plot_dir <- file.path(analysis_dir, "plots")

source(file.path(root_dir, "figures", "theme.R"))
```

Set file paths
```{r file paths}
hallmark_enr_file <- file.path(input_dir, "PBTA_hallmark_enrichment.csv")
kegg_enr_file <- file.path(input_dir, "PBTA_pathway_enrichment_rm_pw_with_genes_gt20_plp.csv")
dna_repair_enr_file <- file.path(input_dir, "PBTA_DNA_REPAIR_geneset_enrichment.csv")
```

Wrangle data
```{r data wrangling}
hallmark_enr <- read_csv(hallmark_enr_file) %>%
  dplyr::select(pathway_id, pathway_name, genes, control_cohort, 
                count_with_plp_case, count_without_plp_case, 
                count_with_plp_control, count_without_plp_control,
                p, OR, ci.int1, ci.int2, FDR) %>%
  dplyr::mutate(database = "Hallmark") %>%
  dplyr::mutate(pathway_name = str_to_sentence(pathway_name))

kegg_enr <- read_csv(kegg_enr_file) %>%
  dplyr::select(-FDR) %>%
  dplyr::rename(FDR = FDR.filtered) %>%
  dplyr::select(pathway_id, pathway_name, genes, control_cohort, 
                count_with_plp_case, count_without_plp_case, 
                count_with_plp_control, count_without_plp_control,
                p, OR, ci.int1, ci.int2, FDR) %>%
  dplyr::mutate(database = "KEGG")

dna_repair_enr <- read_csv(dna_repair_enr_file) %>%
  dplyr::select(pathway_id, pathway_name, genes, control_cohort, 
                count_with_plp_case, count_without_plp_case, 
                count_with_plp_control, count_without_plp_control,
                p, OR, ci.int1, ci.int2) %>%
  dplyr::mutate(FDR = p,
                database = "Other")
```

Merge enrichment results and filter for only pathways enriched relative to all three control cohorts

```{r}
pathway_enr <- hallmark_enr %>%
  bind_rows(kegg_enr, dna_repair_enr) %>%
  write_tsv(file.path(results_dir, "pathway-plp-enrichment-merged.tsv"))

# get enriched pathways in PBTA relative to gnomAD
sig_gnomad <- pathway_enr %>%
  filter(control_cohort == "gnomAD" & FDR < 0.05 & OR > 1) %>%
  pull(pathway_id)

# get enriched pathways in PBTA relative to PMBB cohorts
sig_pmbb_nocancer <- pathway_enr %>%
  filter(control_cohort == "PMBB_noCancer" & FDR < 0.05 & OR > 1) %>%
  pull(pathway_id)

sig_pmbb_notumor <- pathway_enr %>%
  filter(control_cohort == "PMBB_noTumor" & FDR < 0.05 & OR > 1) %>%
  pull(pathway_id)

# identify intersect
enr_all <- Reduce(intersect, list(sig_gnomad, sig_pmbb_nocancer, sig_pmbb_notumor))

# filter for only enriched pathways relative to all cohorts, and remove overall CPG enrichment
sig_pathway_enr <- pathway_enr %>%
  filter(pathway_id %in% enr_all & !grepl("CPG", pathway_id)) %>%
  select(-genes)
```

Create rows for PBTA "enrichment" to be used as reference in plots, retaining PLP counts and setting OR, p, and CI values to `NA`

```{r}
pbta_pathway_enr <- sig_pathway_enr %>%
  select(-count_with_plp_control, -count_without_plp_control) %>%
  distinct(pathway_id, .keep_all = T) %>%
  dplyr::rename(cohort = control_cohort,
                count_with_plp = count_with_plp_case,
                count_without_plp = count_without_plp_case) %>%
  dplyr::mutate(cohort = "PBTA",
                p = NA, OR = NA, 
                ci.int1 = NA, ci.int2 = NA, FDR = NA)

# retain only cohort counts with and without PLP, and merge PBTA reference rows
sig_pathway_enr <- sig_pathway_enr %>%
  dplyr::rename(cohort = control_cohort,
                count_with_plp = count_with_plp_control,
                count_without_plp = count_without_plp_control) %>%
  dplyr::select(-count_with_plp_case, -count_without_plp_case) %>%
  bind_rows(pbta_pathway_enr) %>%
  arrange(pathway_id) %>%
  dplyr::mutate(cohort = factor(cohort, 
                                levels = c("gnomAD", "PMBB_noTumor",
                                           "PMBB_noCancer", "PBTA")))
```

Add cohort percent PLP and fractions as strings, and define pathway plotting order as most to least significant 

```{r}
sig_pathway_enr <- sig_pathway_enr %>%
  dplyr::mutate(cohort_perc = count_with_plp/(count_with_plp + count_without_plp) * 100,
                fraction = glue::glue("{count_with_plp}/{count_with_plp + count_without_plp}"))

pathway_order <- sig_pathway_enr %>%
  arrange(p) %>%
  distinct(pathway_name) %>%
  pull(pathway_name)

sig_pathway_enr <- sig_pathway_enr %>%
  dplyr::mutate(pathway_name = factor(pathway_name,
                                      levels = pathway_order))
```

Plot fisher's exact test p-values, odds ratios, and cohort percentages. 

```{r}

# FDR plot
pval_plot <- sig_pathway_enr %>% 
  arrange(pathway_name) %>%
  ggplot(aes(x = -log10(FDR), y = factor(cohort))) +
  geom_point(size = 3, show.legend = FALSE, color = "#00A087FF") + 
  labs(x = "-log10(FDR)", y = "") + 
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") + 
  facet_wrap(~factor(pathway_name), nrow = 14, scale = "fixed") +
  coord_cartesian(xlim = c(0,45)) + 
  theme_Publication() +
  theme(plot.margin = unit(c(2,1,1,0), "lines"))


# Odds ratio plot
enr_plot <- sig_pathway_enr %>% 
  ggplot(aes(x = factor(cohort), y = OR)) +
  geom_point(size = 3, color = "#00A087FF",
             show.legend = FALSE) + 
  geom_errorbar(aes(ymin = ci.int1, ymax = ci.int2), width = 0.2, 
                show.legend = FALSE, color = "#00A087FF") +
  labs(y = "Odds Ratio (95% CI)", x = NULL) + 
  scale_x_discrete(labels=c("PBTA" = "", "gnomAD" = "",
                            "PMBB_noCancer" = "",
                            "PMBB_noTumor" = "")) +
  coord_flip() +
  facet_wrap(~pathway_name, nrow = 14, scale = "fixed") +
  expand_limits(y=0) +
  theme_Publication() +
  theme(plot.margin = unit(c(2,0.5,1,0.25), "lines"))


# percentage plot
perc_plot <- sig_pathway_enr %>%
  ggplot(aes(x = cohort_perc, y = factor(cohort), label = fraction)) +
  geom_bar(stat = "identity", color = "black",
           show.legend = TRUE) + 
  geom_text(x = 23, hjust = 0, size = 4, fontface = 2) +
  labs(x = "% Cohort P/LP", y = NULL, fill = NULL) + 
  scale_y_discrete(labels=c("PBTA" = "", "gnomAD" = "",
                            "PMBB_noCancer" = "",
                            "PMBB_noTumor" = "")) +
  guides(fill = guide_legend(nrow = 1)) +
  facet_wrap(~pathway_name, nrow = 14, scale = "fixed") +
  expand_limits(x=2) +
  coord_cartesian(clip = 'off') +
  theme_Publication() +
  theme(plot.margin = unit(c(2,5,1,1), "lines"),
        legend.position = c(0.5, 1.07))

# Merge plots and save
ggarrange(pval_plot, enr_plot, perc_plot,
          nrow = 1, widths = c(1.5,0.95,1.3))

ggsave(file.path(plot_dir, "sig-pathway-PLP-enrichment-PBTA-vs-control.pdf"),
     width = 10, height = 15, units = "in")
```

