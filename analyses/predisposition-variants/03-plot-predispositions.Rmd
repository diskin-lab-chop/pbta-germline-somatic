---
title: 'Plot predisposition variants among cancer predisposition patients'
output: 
  html_document:
  toc: TRUE
toc_float: TRUE
author: Ryan Corbett
date: "2023"
---

Load packages and set directories

```{r load libraries}
suppressPackageStartupMessages({
  library(data.table)
  library(tidyverse)
  library(ggplot2)
  library(ggsci)
})

root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))

data_dir <- file.path(root_dir, "data")
analysis_dir <- file.path(root_dir, "analyses", "predisposition-variants")
input_dir <- file.path(analysis_dir, "input")
results_dir <- file.path(analysis_dir, "results") 
plots_dir <- file.path(analysis_dir, "plots")

source(file.path(root_dir, "figures", "theme.R"))
```

Set paths for: 
- histologies file, 
- germline plp variant file

```{r set paths}
histologies_file <- file.path(root_dir, "analyses", "collapse-tumor-histologies", "results","germline-primary-plus-tumor-histologies-plot-groups-clin-meta.tsv")

plp_file <- file.path(data_dir, "pbta_germline_plp_calls.tsv")

predispositions_file <- file.path(input_dir, "predisposition-syndromes.tsv")

predispositions_path_review_file <- file.path(input_dir, "predispositions-path-review.tsv")
```

Read in histologies, germline PLP, and tmb file. Subset histologies file to include only HGG tumors

```{r read files}
hist <- read_tsv(histologies_file, guess_max = 10000, 
                 show_col_types = FALSE) 

plp <- read_tsv(plp_file, show_col_types = FALSE)

syndromes <- read_tsv(predispositions_file) %>%
  dplyr::mutate(`Associated Syndrome` = case_when(
    `Associated Syndrome` == "Familial Adenomatous Polyposis" ~ "FAP",
    `Associated Syndrome` == "Rhabdoid Tumor Predisposition syndrome" ~ "RTPS",
    TRUE ~ `Associated Syndrome`
  ))
```

Define cancer predispositions and associated genes

```{r}
predisposition_genes <- c("Li-Fraumeni syndrome" = "TP53", "NF-1" = "NF1", "NF-2" = "NF2", "Schwannomatosis" = "LZTR1", "Tuberous Sclerosis" = "TSC1|TSC2")
predispositions <- names(predisposition_genes)
```

Loop through cancer predispositions and create a data frame indicating presence/absence of associated gene germline PLP variant

```{r}
predisposition_list <- list()

suppressWarnings(
  for (predisposition in predispositions) {
    
  genes <- unlist(strsplit(predisposition_genes[predisposition], "[|]"))
  
  predisposition_list[[predisposition]] <- hist %>%
    filter(grepl(predisposition, cancer_predispositions)) %>%
    dplyr::select(Kids_First_Participant_ID, Kids_First_Biospecimen_ID_normal, sample_id_normal, sample_id_tumor, plot_group, molecular_subtype) %>%
    dplyr::mutate(predisposition = predisposition) %>%
    dplyr::mutate(plp_variant = case_when(
      Kids_First_Biospecimen_ID_normal %in% plp$Kids_First_Biospecimen_ID[plp$Hugo_Symbol %in% genes] ~ "Yes",
      TRUE ~ "No"
    ))
  }
)

predisposition_df <- Reduce(rbind, predisposition_list)
```

Filter for patients that do not show P-LP variant associated with predisposition syndrome, and write to output
```{r}
predisposition_df %>%
  dplyr::filter(plp_variant == "No") %>%
  write_tsv(file.path(results_dir, "predisposition-patients-no-plp-variants.tsv"))
  
```

Create bar plot of patients with/without PLP germline variants in gene associated with each cancer predisposition syndrome

```{r}
labels <- c("Schwannomatosis (LZTR1)",
            "Li-Fraumeni Syndrome (TP53)",
            "NF-2 (NF2)",
            "Tuberous Sclerosis (TSC1/2)",
            "NF-1 (NF1)")

predisposition_df %>%
  count(predisposition, plp_variant) %>%
  dplyr::mutate(predisposition = fct_relevel(predisposition,
                                      c("Schwannomatosis", "Li-Fraumeni syndrome", 
                                        "NF-2", "Tuberous Sclerosis", "NF-1"))) %>%
  dplyr::mutate(plp_variant = fct_relevel(plp_variant,
                                      c("Yes", "No"))) %>%
  ggplot(aes(x = n, y = predisposition, fill = plp_variant)) + 
  geom_bar(stat = "identity", 
           colour = "black") +
  labs(x = "No. patients",
       y = "",
       fill = "P/LP variant") +
  scale_y_discrete(labels=labels) +
  scale_fill_npg() +
  theme_Publication() +
  theme(legend.position = "top") +
  guides(fill=guide_legend(ncol=2)) +
  xlim(c(0,30))

ggsave(file.path(plots_dir, "gene-plp-prevalence-by-syndrome.pdf"),
       width = 5, height = 4)
```

```{r}
syndrome_genes <- syndromes$Hugo_Symbol
recorded_predispositions <- c("Li-Fraumeni syndrome", 
                              "NF-1", "NF-2", 
                              "Schwannomatosis", 
                              "Tuberous Sclerosis")

predispositions_path_review <- read_tsv(predispositions_path_review_file)

predisposition_gene_list <- list()

for (gene in syndrome_genes){
  gene_plp <- plp %>%
    filter(Hugo_Symbol == gene)
  
  syndrome <- syndromes$`Associated Syndrome`[syndromes$Hugo_Symbol == gene]
  
  predisposition_gene_list[[gene]] <- hist %>%
    filter(Kids_First_Biospecimen_ID_normal %in% gene_plp$Kids_First_Biospecimen_ID) %>%
    dplyr::select(Kids_First_Biospecimen_ID_normal, cancer_predispositions) %>%
    dplyr::mutate(Hugo_Symbol = gene) %>%
    dplyr::mutate(associated_syndrome = syndrome) %>%
    dplyr::mutate(predisposition = case_when(
      grepl(syndrome, cancer_predispositions) ~ "Yes",
      Kids_First_Biospecimen_ID_normal %in% predispositions_path_review$Kids_First_Biospecimen_ID_normal ~ "Yes",
      TRUE ~ "No"
    )) %>%
    select(-cancer_predispositions)
  
}

predisposition_gene_df <- Reduce(rbind, predisposition_gene_list)
```


```{r}

total_cts <- predisposition_gene_df %>%
  count(Hugo_Symbol) %>%
  arrange(n)

labels <- glue::glue("{syndrome_genes} ({syndromes$`Associated Syndrome`})")
names(labels) <- syndrome_genes

predisposition_gene_df %>%
  count(Hugo_Symbol, predisposition) %>%
  mutate(Hugo_Symbol = fct_relevel(Hugo_Symbol,
                                      total_cts$Hugo_Symbol)) %>%
  mutate(predisposition = fct_relevel(predisposition,
                                      c("Yes", "No"))) %>%
  ggplot(aes(x = n, y = Hugo_Symbol, fill = predisposition)) + 
  geom_bar(stat = "identity", 
           colour = "black") +
  labs(x = "No. patients",
       y = "",
       fill = "Predisposition gene clinically-reported") +
  theme(legend.position = "top") +
  scale_y_discrete(labels=labels) +
  scale_fill_npg() +
  theme_Publication() +
  theme(legend.position = "top") +
  guides(fill=guide_legend(ncol=3))

ggsave(file.path(plots_dir, "syndrome-prevalence-by-gene.pdf"),
       width = 6, height = 5)
```

