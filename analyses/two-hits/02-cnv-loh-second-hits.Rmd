---
title: "Assess somatic CNV and LOH second hits"
output: 
  html_notebook:
  toc: TRUE
toc_float: TRUE
author: Ryan Corbett
---

This analysis identifies patients with germline P-LP variants in cancer predisposition genes that show subsequent seconds CNV or loss of heterozygosity (LOH) hits in tumors 

Set libraries and file paths
```{r load libraries}
# load libraries
library(tidyverse)
library(ggplot2)
library(ggpubr)

# define directories 
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
analysis_dir <- file.path(root_dir, "analyses", "two-hits")
input_dir <- file.path(analysis_dir, "input")
results_dir <- file.path(analysis_dir, "results")
plot_dir <- file.path(analysis_dir, "plots")
data_dir <- file.path(root_dir, "data")

# If the input and results directories do not exist, create it
if (!dir.exists(results_dir)) {
  dir.create(results_dir, recursive = TRUE)
}

source(file.path(root_dir, "figures", "theme.R"))
```

Define file paths
```{r set file paths}
# germline P-LP calls 
plp_file <- file.path(root_dir, "analyses", 
                      "variant-distribution", "input", 
                      "pbta_germline_plp_calls_autogvp_abridged_gnomad_popmax.tsv")

plp_sv_file <- file.path(root_dir, "analyses", 
                         "germline-sv", "input", 
                         "pbta_germline_svs.tsv")

# add histologies file 
histologies_file <- file.path(root_dir, "analyses",
                           "collapse-tumor-histologies",
                           "input", "histologies.tsv")
plot_mapping_file <- file.path(root_dir, "analyses", "collapse-tumor-histologies/input/plot-mapping.tsv")

# cnv file with annotation 
cnv_auto_file <- file.path(data_dir, "consensus_seg_annotated_cn_autosomes.tsv.gz")
cnv_xy_file <- file.path(data_dir, "consensus_seg_annotated_cn_x_and_y.tsv.gz")

# LOH variant and gene files
loh_variant_file <- file.path(input_dir, "pbta-plp-all-loh.tsv")
loh_gene_file <- file.path(data_dir, "pbta-all-gene-loh.tsv.gz")

# cpg file
cpg_file <- file.path(root_dir, "analyses", "oncokb-annotation", "input", "cpg.txt")
hgat_file <- file.path(root_dir, "analyses", "variant-distribution", "input", "hgat_goi_list.tsv")
lgat_file <- file.path(root_dir, "analyses", "variant-distribution", "input", "lgat_goi_list.tsv")
embryonal_file <- file.path(root_dir, "analyses", "variant-distribution", "input", "embryonal-tumor_goi_list.tsv")
other_file <- file.path(root_dir, "analyses", "variant-distribution", "input", "other_goi_list.tsv")

```

Read in PLP, histology, and cpg files. Subset P-LP calls to CPGs only and add histology

```{r get all matched tumors}

# Load abridged P-LP file and append variant coordinates
germline <- read_tsv(plp_file) %>%
  dplyr::rename(Hugo_Symbol = gene_symbol_vep)

germline_sv <- read_tsv(plp_sv_file) %>%
  dplyr::rename(Hugo_Symbol = Hugo_Symbol_cpg)

plot_mapping <- read_tsv(plot_mapping_file)

hist <- read_tsv(histologies_file) %>%
  left_join(plot_mapping[,c("cancer_group", "plot_group")])

hist_tumor <- hist %>%
  dplyr::filter(sample_type == "Tumor" & experimental_strategy %in% c("WGS", "WXS")) %>%
  dplyr::rename("Kids_First_Biospecimen_ID_tumor" = Kids_First_Biospecimen_ID)

hist_normal <- hist %>%
  dplyr::filter(sample_type == "Normal") %>%
  dplyr::rename("Kids_First_Biospecimen_ID_normal" = Kids_First_Biospecimen_ID)

# CPGs
cpgs <- read_lines(cpg_file)
hgat_drivers <- read_lines(hgat_file)
lgat_drivers <- read_lines(lgat_file)
embryonal_drivers <- read_lines(embryonal_file)
other_drivers <- read_lines(other_file)
somatic_drivers <- c(hgat_drivers, lgat_drivers, embryonal_drivers, other_drivers)

# filter PLP calls for cpgs, and add plot_group and molecular_subtype
germline <- germline %>%
  filter(Hugo_Symbol %in% c(cpgs, somatic_drivers)) %>%
  left_join(hist_normal[,c("Kids_First_Participant_ID", "Kids_First_Biospecimen_ID_normal")]) %>%
  left_join(hist_tumor[,c("Kids_First_Participant_ID", "Kids_First_Biospecimen_ID_tumor",
                    "plot_group", "molecular_subtype")], by = "Kids_First_Participant_ID") %>%
  dplyr::select(Kids_First_Biospecimen_ID_normal, Kids_First_Participant_ID, 
                Kids_First_Biospecimen_ID_tumor, 
                plot_group, molecular_subtype,
                Hugo_Symbol, autogvp_call, autogvp_call_reason,
                chr, start, ref, alt,
                HGVSc, HGVSp) %>%
  distinct(Kids_First_Biospecimen_ID_normal, Kids_First_Biospecimen_ID_tumor, Hugo_Symbol, start, .keep_all = T)

germline_sv <- germline_sv %>%
  filter(Hugo_Symbol %in% cpgs) %>%
  left_join(hist_normal[,c("Kids_First_Participant_ID", "Kids_First_Biospecimen_ID_normal")]) %>%
  left_join(hist_tumor[,c("Kids_First_Participant_ID", "Kids_First_Biospecimen_ID_tumor",
                    "plot_group", "molecular_subtype")], by = "Kids_First_Participant_ID") %>%
  dplyr::select(Kids_First_Biospecimen_ID_normal, Kids_First_Participant_ID, 
                Kids_First_Biospecimen_ID_tumor, 
                plot_group, molecular_subtype,
                Hugo_Symbol,
                Chromosome, Start, End, Length,
                Type, Classification) %>%
  distinct(Kids_First_Biospecimen_ID_normal, Kids_First_Biospecimen_ID_tumor, Hugo_Symbol, .keep_all = T)

```

Load CNV files, and identify patients with germline PLP variant and somatic CNV in same CPG
```{r get cnv data}

# filter cnv to patients in cohort and CPG calls only
cnv_auto <- read_tsv(cnv_auto_file) %>%
  dplyr::filter(biospecimen_id %in% germline$Kids_First_Biospecimen_ID_tumor & gene_symbol %in% c(cpgs, somatic_drivers)) %>%
  dplyr::rename("Hugo_Symbol" = gene_symbol,
         "Kids_First_Biospecimen_ID_tumor" = biospecimen_id,
         "CNV_status_somatic" = status,
         "copy_number_somatic" = copy_number,
         "ploidy_somatic" = "ploidy") %>%
  dplyr::select(Hugo_Symbol, Kids_First_Biospecimen_ID_tumor,
         CNV_status_somatic)

cnv_xy <- read_tsv(cnv_xy_file) %>%
  dplyr::filter(biospecimen_id %in% germline$Kids_First_Biospecimen_ID_tumor & gene_symbol %in% c(cpgs, somatic_drivers)) %>%
  dplyr::rename("Hugo_Symbol" = gene_symbol,
         "Kids_First_Biospecimen_ID_tumor" = biospecimen_id,
         "CNV_status_somatic" = status,
         "copy_number_somatic" = copy_number,
         "ploidy_somatic" = "ploidy") %>%
  dplyr::select(Hugo_Symbol, Kids_First_Biospecimen_ID_tumor,
         CNV_status_somatic)

# merge cnv tables
cnv <- cnv_auto %>%
  bind_rows(cnv_xy)

# merge germline SNV and somatic CNV calls by bs and gene id
germline_somatic_cnvs <- germline %>%
  left_join(cnv, by = c("Kids_First_Biospecimen_ID_tumor", "Hugo_Symbol")) %>%
  dplyr::mutate(CNV_status_somatic = case_when(
    is.na(CNV_status_somatic) ~ "neutral",
    TRUE ~ CNV_status_somatic
  )) %>%
  distinct()

germline_sv_somatic_cnvs <- germline_sv %>%
  left_join(cnv, by = c("Kids_First_Biospecimen_ID_tumor", "Hugo_Symbol")) %>%
  dplyr::mutate(CNV_status_somatic = case_when(
    is.na(CNV_status_somatic) ~ "neutral",
    TRUE ~ CNV_status_somatic
  )) %>%
  distinct()

```

Read in LOH results, and append LOH scores to rows of `germline_somatic_cnvs`
```{r get variant loh data}

loh <- read_tsv(loh_variant_file) %>%
  dplyr::filter(start %in% germline$start) %>%
  dplyr::rename(Kids_First_Biospecimen_ID_normal = BS_ID,
         Kids_First_Biospecimen_ID_tumor = BS_ID_tumor) %>%
  dplyr::filter(!is.na(proband_tumor_alt_depth))

ggplot(loh, aes(x = proband_germline_vaf, y = proband_tumor_vaf,
                colour = loh_score)) +
  geom_point() +
  labs(x = "Germline VAF",
       y = "Tumor VAF", color = "LOH score") +
  scale_color_gradient(low = "blue", high = "orangered") + 
  theme_Publication()

ggsave(file.path(plot_dir, "tumor-vaf-vs-germline-vaf.pdf"),
       width = 5, height = 4)

```




```{r}
germline_somatic_cnvs_loh <- germline_somatic_cnvs %>%
  left_join(loh[,c("Kids_First_Biospecimen_ID_tumor", 
                   "chr", "start", "proband_germline_vaf", "proband_tumor_vaf", 
                   "loh_score")], 
            by = c("Kids_First_Biospecimen_ID_tumor", "chr", "start")) %>%
  distinct()

```

Load gene LOH data and append to `germline_somatic_cnvs_loh`
```{r get gene loh data}

loh_gene <- read_tsv(loh_gene_file) %>%
  dplyr::filter(Hugo_Symbol %in% c(cpgs, somatic_drivers)) %>%
  dplyr::rename(gene_LOH = LOH_score) %>%
  dplyr::select(Kids_First_Biospecimen_ID_normal, Kids_First_Biospecimen_ID_tumor, Hugo_Symbol,
         gene_LOH)

germline_somatic_cnvs_loh_gene <- germline_somatic_cnvs_loh %>%
  left_join(loh_gene)

germline_sv_somatic_cnvs_loh_gene <- germline_sv_somatic_cnvs %>%
  left_join(loh_gene)

```

Save CNV and LOH scores for all samples to output
```{r save results}

germline_somatic_cnvs_loh_gene %>%
  dplyr::filter(Hugo_Symbol %in% cpgs) %>%
  write_tsv(file.path(results_dir, "germline-somatic-cnv-loh-cpgs.tsv"))

germline_somatic_cnvs_loh_gene %>%
  dplyr::filter(!Hugo_Symbol %in% cpgs) %>%
  write_tsv(file.path(results_dir, "germline-somatic-cnv-loh-somatic-non-cpgs.tsv"))

germline_sv_somatic_cnvs_loh_gene %>%
  write_tsv(file.path(results_dir, "germline-sv-somatic-cnv-loh-somatic-cpgs.tsv"))

```

## Plotting LOH by gene and P-LP status

For plotting, we will use LOH scores from one matched tumor sample per patient, specified in the cohort histologies file
```{r subset for plotting}

germline_all <- germline %>%
  dplyr::select(Kids_First_Biospecimen_ID_normal, Hugo_Symbol, plot_group) %>%
  bind_rows(germline_sv %>% dplyr::select(Kids_First_Biospecimen_ID_normal, Hugo_Symbol, plot_group))

hist_cohort <- read_tsv(file.path(root_dir, "analyses", 
                                  "collapse-tumor-histologies", "results", 
                                  "germline-primary-plus-tumor-histologies-plot-groups-clin-meta.tsv"))

loh_gene <- loh_gene %>%
  # filter for only tumor IDs in cohort histologies
  dplyr::filter(Kids_First_Biospecimen_ID_tumor %in% hist_cohort$Kids_First_Biospecimen_ID_tumor) %>%
  # add column indicating germline P/LP status for each gene and patient
  dplyr::mutate(is_plp = case_when(
    glue::glue("{Kids_First_Biospecimen_ID_normal}:{Hugo_Symbol}") %in% glue::glue("{germline_all$Kids_First_Biospecimen_ID_normal}:{germline_all$Hugo_Symbol}") ~ "Yes",
    TRUE ~ "No"
  )) %>%
  # append plot_group and hex code for plotting
  left_join(germline_all[,c("Kids_First_Biospecimen_ID_normal", "plot_group")]) %>%
  left_join(plot_mapping[,c("plot_group", "plot_group_hex")]) %>%
  distinct(Kids_First_Biospecimen_ID_normal, Kids_First_Biospecimen_ID_tumor, Hugo_Symbol, .keep_all = TRUE)

```

For genes with P/LP variants in >= 4 patients, plot LOH scores by P/LP status 
```{r plot LOH by P/LP status}

# Get list of genes with P/LP variants in at least 4 patients
cpgs_test <- germline_all %>%
  dplyr::filter(Hugo_Symbol %in% cpgs) %>%
  distinct(Kids_First_Biospecimen_ID_normal, Hugo_Symbol, .keep_all = T) %>%
  count(Hugo_Symbol) %>%
  filter(n >= 4) %>%
  pull(Hugo_Symbol)

# define color palette
plot_group_palette <- loh_gene$plot_group_hex
names(plot_group_palette) <- loh_gene$plot_group

set.seed(1)

# plot 
loh_gene %>%
  # Filter out RAD50 because there is no LOH score data available in patients with P/LP variants
  filter(Hugo_Symbol %in% cpgs_test & !Hugo_Symbol %in% c("RAD50", "RAD51D")) %>%
  
  ggplot(aes(x = is_plp, y = gene_LOH)) + 
  geom_jitter(aes(fill = plot_group), shape = 21, width = 0.2, size = 2.5, alpha = 0.85) +
  geom_boxplot(alpha = 0.05, outlier.shape = NA) +
  stat_compare_means(method = "wilcox",
                     comparisons = list(c("Yes", "No")),
                     method.args = list(alternative = "greater")) + 
  geom_hline(yintercept = 0.25, linetype = "dashed", color = "gray") + 
  labs(x = "Germline P/LP variant", y = "gene LOH score", color = "Histology") +
  ylim(c(0,0.75)) +
  scale_fill_manual(values = plot_group_palette, 
                     breaks = sort(names(plot_group_palette))) +
  facet_wrap(~Hugo_Symbol, nrow = 3) + 
  theme_Publication()

  ggsave(file.path(plot_dir, "cpg-LOH-plp-vs-noplp.pdf"),
                 width = 14, height = 7)

```

Look at LOH score differences for genes within histologies 
```{r plot LOH by P/LP status within histologies}

# define group_gene column
loh_gene <- loh_gene %>%
  dplyr::mutate(group_gene = glue::glue("{Hugo_Symbol}: {plot_group}"))

# Identify histology-gene pairs for which there are at least 3 patients with P/LP variants in group
plot_group_gene <- loh_gene %>%
  distinct(Kids_First_Biospecimen_ID_normal, Hugo_Symbol, .keep_all = TRUE) %>%
  filter(is_plp == "Yes") %>%
  count(group_gene) %>%
  dplyr::filter(n >= 2) %>%
  pull(group_gene)

compare_means_result <- loh_gene %>%
  dplyr::filter(group_gene %in% plot_group_gene & group_gene != "NF1: Neurofibroma plexiform") %>%
  group_by(group_gene) %>%
  summarize(p_value = wilcox.test(gene_LOH ~ is_plp)$p.value)

to_plot <- compare_means_result %>%
  dplyr::filter(p_value < 0.05) %>%
  pull(group_gene)

# plot LOH scores by P/LP status within histologies for selected gene-histology pairs
loh_gene %>%
  dplyr::filter(group_gene %in% to_plot) %>%
  
   ggplot(aes(x = is_plp, y = gene_LOH)) + 
    geom_jitter(aes(fill = plot_group), shape = 21, 
                width = 0.2, size = 2.5, alpha = 0.85) +
    geom_boxplot(alpha = 0.05, outlier.shape = NA) +
    stat_compare_means(method = "wilcox",
                       comparisons = list(c("Yes", "No")),
                       method.args = list(alternative = "greater")) + 
    geom_hline(yintercept = 0.25, linetype = "dashed", color = "gray") + 
    labs(x = "Germline P/LP variant", y = "gene LOH score",
         fill = "Histology") +
    ylim(c(0,0.75)) +
    scale_fill_manual(values = plot_group_palette, breaks = sort(names(plot_group_palette)), na.translate = F) +
    facet_wrap(~group_gene, nrow = 1,
               labeller = labeller(group_gene = label_wrap_gen(18))) + 
    theme_Publication()

  
  ggsave(file.path(plot_dir, "hist-gene-LOH-plp-vs-noplp.pdf"),
                   width = 12, height = 3)

```

```{r}
sessionInfo()

```