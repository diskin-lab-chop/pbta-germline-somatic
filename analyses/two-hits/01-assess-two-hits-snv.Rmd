---
title: "Assess second hits"
output: 
  html_notebook:
  toc: TRUE
toc_float: TRUE
author: Jo Lynne Rokita
params:
  maf_in:
    label: "OncoKB-Annotated MAF input file"
    value: analyses/oncokb-annotation/results/snv-consensus-plus-hotspots-goi-oncokb.maf.tsv
    input: file
  germ_in:
    label: "germline file"
    value: data/pbta-merged-plp-variants-autogvp-abridged.tsv
    input: file
editor_options: 
  chunk_output_type: inline
---
### Set libraries and file paths

```{r load libraries}
# load libraries
library(tidyverse)

# define directories 
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
analysis_dir <- file.path(root_dir, "analyses", "two-hits")
results_dir <- file.path(analysis_dir, "results")
data_dir <- file.path(root_dir, "data")
plot_dir <- file.path(analysis_dir, "plots")

# If the input and results directories do not exist, create it
if (!dir.exists(results_dir)) {
  dir.create(results_dir, recursive = TRUE)
}

# add histologies file so we can subset maf
histologies_file <- file.path(root_dir,"analyses", 
                              "collapse-tumor-histologies", "results", 
                              "germline-primary-plus-tumor-histologies-plot-groups-clin-meta.tsv")

# remove cell lines from histologies file
opc_hist_file <- file.path(root_dir, "analyses",
                           "collapse-tumor-histologies",
                           "input", "histologies.tsv")

plp_sv_file <- file.path(root_dir, "analyses", "germline-sv",
                    "input", "pbta_germline_svs.tsv")

# goi file
cpg_file <- file.path(root_dir, "analyses", "oncokb-annotation", "input", "cpg.txt")

```

### Load oncokb annotated maf and explore data

```{r load files}
germline <- read_tsv(file.path(root_dir, params$germ_in)) %>%
  dplyr::rename(Matched_Norm_Sample_Barcode = Kids_First_Biospecimen_ID_normal,
                Hugo_Symbol = gene_symbol_vep,
                HGVSc_germ = HGVSc,
                HGVSp_germ = HGVSp) 

integrated_hist <- read_tsv(histologies_file)
opc_hist <- read_tsv(opc_hist_file, guess_max = 3000) %>%
  filter(!is.na(pathology_diagnosis),
         experimental_strategy == "WGS",
         tumor_descriptor != "Derived Cell Line")

# CPGs
cpg <- read_lines(cpg_file)

# load maf
maf <- data.table::fread(file.path(root_dir, params$maf_in), data.table = F) %>%
  filter(Tumor_Sample_Barcode %in% opc_hist$Kids_First_Biospecimen_ID)

# CPGs without somatic hits
setdiff(cpg, unique(maf$Hugo_Symbol))

# table of gene counts by oncogenic effect
maf %>%
  count(ONCOGENIC) %>%
  arrange(-n)

# filter known oncogenic/likely oncogenic/resistance hits
onco_hits <- maf %>%
  filter(ONCOGENIC %in% c("Likely Oncogenic", "Oncogenic", "Resistance")) %>%
  write_tsv(file.path(results_dir, "pbta-oncokb-oncogenic-maf.tsv"))

# prevalence by gene
onco_hits %>%
  count(Hugo_Symbol) %>%
  arrange(-n)

# prevalence by variant in oncokb
onco_hits %>%
  count(VARIANT_IN_ONCOKB) %>%
  arrange(-n)

# prevalence by variant in oncokb
onco_hits %>%
  count(MUTATION_EFFECT) %>%
  arrange(-n)

# how many are hotspots?
onco_hits %>%
  count(HotSpotAllele) %>%
  arrange(-n)

```

### Integrate with germline data

```{r two hits same gene}
# collapse calls a bit
onco_hits_subset <- onco_hits %>%
  mutate(VAF = t_alt_count / t_depth) %>%
  select(Matched_Norm_Sample_Barcode, Tumor_Sample_Barcode, Hugo_Symbol, Transcript_ID, HGVSc, HGVSp, VAF, SIFT, PolyPhen, Variant_Classification, HotSpotAllele, ONCOGENIC, MUTATION_EFFECT, VARIANT_IN_ONCOKB)

# two hit CPG matches
germline_somatic_gene_matches <- germline %>%
  inner_join(onco_hits_subset, by = c("Matched_Norm_Sample_Barcode", "Hugo_Symbol")) %>%
  write_tsv(file.path(results_dir, "germline-somatic-two-gene-hits.tsv"))
```

### List germline + somatic gene hits by sample

```{r gene hits by patient}
collapsed <- germline %>%
  filter(Hugo_Symbol %in% cpg) %>%
  dplyr::rename(Kids_First_Biospecimen_ID_normal = Matched_Norm_Sample_Barcode) %>%
  group_by(Kids_First_Biospecimen_ID_normal) %>%
  summarise(Hugo_Symbol = str_c(sort(unique(Hugo_Symbol)), collapse = "; ")) %>%
  left_join(integrated_hist)

collapsed_onco <- onco_hits_subset %>%
  dplyr::rename(Kids_First_Biospecimen_ID_normal = Matched_Norm_Sample_Barcode,
                Kids_First_Biospecimen_ID_tumor_maf = Tumor_Sample_Barcode,
                Hugo_Symbol_somatic = Hugo_Symbol) %>%
  group_by(Kids_First_Biospecimen_ID_normal, Kids_First_Biospecimen_ID_tumor_maf) %>%
  summarise(Hugo_Symbol_somatic = str_c(sort(unique(Hugo_Symbol_somatic)), collapse = "; "))

collapsed_germ_som <- collapsed %>%
  left_join(collapsed_onco, by = "Kids_First_Biospecimen_ID_normal") %>%
  write_tsv(file.path(results_dir, "germline-somatic-collapsed-by-gene.tsv"))
```


```{r}
germline_sv <- read_tsv(plp_sv_file) %>%
  dplyr::rename(Matched_Norm_Sample_Barcode = Kids_First_Biospecimen_ID_normal,
                Hugo_Symbol = Hugo_Symbol_cpg) 

# two hit CPG matches
germline_sv_somatic_gene_matches <- germline_sv %>%
  inner_join(onco_hits_subset, by = c("Matched_Norm_Sample_Barcode", "Hugo_Symbol")) %>%
  write_tsv(file.path(results_dir, "germline-sv-somatic-two-gene-hits.tsv"))
```

```{r}
pathway_files <- list.files(file.path(root_dir, "analyses",
                                      "cpg-enrichment", "input"))
pathway_files <- pathway_files[grepl("pathway_genes.tsv", pathway_files)]

pathway_hits_list_germline_snv <- list()
pathway_hits_list_germline_sv <- list()

for (file in pathway_files){
  
  pathway <- str_replace(file, "_KEGG_pathway_genes.tsv", "")
  
  pathway_genes <- read_tsv(file.path(root_dir, "analyses",
                                      "cpg-enrichment", "input",
                                      file)) %>%
    pull(genes)
  
    # collapse calls a bit
  onco_hits_pathway <- onco_hits %>%
    dplyr::filter(Hugo_Symbol %in% pathway_genes) %>%
    mutate(VAF = t_alt_count / t_depth) %>%
    select(Matched_Norm_Sample_Barcode, Tumor_Sample_Barcode, Hugo_Symbol, Transcript_ID, HGVSc, HGVSp, VAF, SIFT, PolyPhen, Variant_Classification, HotSpotAllele, ONCOGENIC, MUTATION_EFFECT, VARIANT_IN_ONCOKB)
  
  # two hit CPG matches
  pathway_hits_list_germline_snv[[pathway]] <- germline %>%
    dplyr::filter(Hugo_Symbol %in% pathway_genes,
                  Hugo_Symbol %in% cpg) %>%
    dplyr::select(Matched_Norm_Sample_Barcode, chr, start, ref, alt, Hugo_Symbol,
                  variant_classification_vep, HGVSc_germ, HGVSp_germ) %>%
    inner_join(onco_hits_pathway, by = c("Matched_Norm_Sample_Barcode"),
               suffix = c("_germ", "_somatic")) %>%
    dplyr::mutate(pathway = pathway)
  
    # two hit CPG matches
  pathway_hits_list_germline_sv[[pathway]] <- germline_sv %>%
    dplyr::filter(Hugo_Symbol %in% pathway_genes,
                  Hugo_Symbol %in% cpg) %>%
    inner_join(onco_hits_pathway, by = c("Matched_Norm_Sample_Barcode"),
               suffix = c("_germ", "_somatic")) %>%
    dplyr::mutate(pathway = pathway)
  
}

pathway_hits_snv_df <- Reduce(rbind, pathway_hits_list_germline_snv)
pathway_hits_sv_df <- Reduce(rbind, pathway_hits_list_germline_sv)

write_tsv(pathway_hits_snv_df,
          file.path(results_dir, "germline-snv-somatic-pathway-second-hits.tsv"))
write_tsv(pathway_hits_sv_df,
          file.path(results_dir, "germline-sv-somatic-pathway-second-hits.tsv"))
```


Print session info
```{r}
sessionInfo()
```