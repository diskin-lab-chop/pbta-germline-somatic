---
title: "Assess somatic CNVs for second hits"
output: 
  html_notebook:
  toc: TRUE
toc_float: TRUE
author: Ryan Corbett
---

This analysis identifies patients with germline P-LP variants in cancer predisposition genes that show subsequent seconds CNV hits in tumors. 

### Set libraries and file paths

```{r load libraries}
# load libraries
library(tidyverse)

# define directories 
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
analysis_dir <- file.path(root_dir, "analyses", "two-hits")
input_dir <- file.path(analysis_dir, "input")
results_dir <- file.path(analysis_dir, "results")
data_dir <- file.path(root_dir, "data")

# If the input and results directories do not exist, create it
if (!dir.exists(results_dir)) {
  dir.create(results_dir, recursive = TRUE)
}

# germline P-LP calls 
plp_file <- file.path(data_dir, "pbta_germline_plp_calls.tsv")

plp_full_file <- file.path(input_dir, "PBTA-838-germline_plp-2023-02-05.tsv")

# add histologies file 
histologies_file <- file.path(root_dir,"analyses", "collapse-tumor-histologies", "results", "germline-primary-plus-tumor-histologies-plot-groups-clin-meta.tsv")

# cnv file with annotation 
cnv_auto_file <- file.path(input_dir, "consensus_seg_annotated_cn_autosomes.tsv")
cnv_xy_file <- file.path(input_dir, "consensus_seg_annotated_cn_x_and_y.tsv")


# loh file
loh_file <- file.path(input_dir, "pbta-plp-all-loh.tsv")


loh_gene_file <- file.path(input_dir, "pbta-all-gene-loh.tsv")

# cpg file
cpg_file <- file.path(root_dir, "analyses", "oncokb-annotation", "input", "cpg.txt")
```

Read in PLP, histology, and cpg files. Subset P-LP calls to CPGs only and add histology

```{r}

plp_full <- read_tsv(plp_full_file)

# rename columns to specify germline
germline <- read_tsv(plp_file) %>%
  left_join(plp_full[,c("Kids_First_Biospecimen_ID", "Hugo_Symbol", "HGVS.c", "Chromosome", "Loc", "Reference", "Alternant_alleles")]) %>%
  rename(Kids_First_Biospecimen_ID_normal = Kids_First_Biospecimen_ID)


# renmae bs id column to match plp file
hist <- read_tsv(histologies_file)

# CPGs
cpgs <- read_lines(cpg_file)

# filter PLP calls and add plot_group and molecular_subtype
germline <- germline %>%
  filter((Hugo_Symbol %in% cpgs | grepl("ERCC5|RMRP", Hugo_Symbol)) & Kids_First_Biospecimen_ID_normal %in% hist$Kids_First_Biospecimen_ID_normal) %>%
  dplyr::mutate(Hugo_Symbol = case_when(
    grepl("ERCC5", Hugo_Symbol) ~ "ERCC5",
    grepl("RMRP", Hugo_Symbol) ~ "RMRP",
    TRUE ~ Hugo_Symbol
  )) %>%
  left_join(hist[,c("Kids_First_Biospecimen_ID_normal", "Kids_First_Biospecimen_ID_tumor",
                               "plot_group", "molecular_subtype")]) %>%
  select(Kids_First_Biospecimen_ID_normal, Kids_First_Biospecimen_ID_tumor, 
         plot_group, molecular_subtype,
         Hugo_Symbol, `L-LP_Call_final`, Reasoning_for_call,
         Chromosome, Loc, Reference, Alternant_alleles,
         HGVS.c, HGVS.p)
```

Identify patients with germline PLP variant and somatic CNV in same CPG

```{r}
# filter cnv to patients in cohort and CPG calls only
cnv_auto <- read_tsv(cnv_auto_file) %>%
  filter(biospecimen_id %in% hist$Kids_First_Biospecimen_ID_tumor & gene_symbol %in% cpgs) %>%
  rename("Hugo_Symbol" = gene_symbol,
         "Kids_First_Biospecimen_ID_tumor" = biospecimen_id,
         "CNV_status_somatic" = status,
         "copy_number_somatic" = copy_number,
         "ploidy_somatic" = "ploidy") %>%
  select(Hugo_Symbol, Kids_First_Biospecimen_ID_tumor,
         CNV_status_somatic)

cnv_xy <- read_tsv(cnv_xy_file) %>%
  filter(biospecimen_id %in% hist$Kids_First_Biospecimen_ID_tumor & gene_symbol %in% cpgs) %>%
  rename("Hugo_Symbol" = gene_symbol,
         "Kids_First_Biospecimen_ID_tumor" = biospecimen_id,
         "CNV_status_somatic" = status,
         "copy_number_somatic" = copy_number,
         "ploidy_somatic" = "ploidy") %>%
  select(Hugo_Symbol, Kids_First_Biospecimen_ID_tumor,
         CNV_status_somatic)

cnv <- cnv_auto %>%
  bind_rows(cnv_xy)

# merge germline SNV and somatic CNV calls by bs and gene id
germline_somatic_cnvs <- germline %>%
  left_join(cnv, by = c("Kids_First_Biospecimen_ID_tumor", "Hugo_Symbol")) %>%
  dplyr::mutate(CNV_status_somatic = case_when(
    is.na(CNV_status_somatic) ~ "neutral",
    TRUE ~ CNV_status_somatic
  )) %>%
  distinct()
```

Read in LOH results, and append LOH scores to rows of `germline_somatic_cnvs`

```{r}
loh <- read_tsv(loh_file) %>%
  rename(Kids_First_Biospecimen_ID_normal = BS_ID,
         Kids_First_Biospecimen_ID_tumor = BS_ID_tumor,
         Chromosome = chr,
         Loc = start)

germline_somatic_cnvs_loh <- germline_somatic_cnvs %>%
  left_join(loh[,c("Kids_First_Biospecimen_ID_normal", "Kids_First_Biospecimen_ID_tumor", 
                   "Chromosome", "Loc", "proband_germline_vaf", "proband_tumor_vaf", 
                   "tumor_fraction", "proband_tumor_vaf_corrected", 
                   "loh_uncorrected")], 
            by = c("Kids_First_Biospecimen_ID_tumor", "Chromosome", "Loc")) %>%
  distinct() %>%
  dplyr::mutate(loh_corrected = loh_uncorrected/tumor_fraction) %>%
  dplyr::mutate(loh_corrected = case_when(
    loh_corrected > 0.5 ~ 0.5,
    loh_corrected < -0.5 ~ -0.5,
    TRUE ~ loh_corrected
  ))


germline_somatic_cnvs_loh %>%
  filter(abs(loh_uncorrected) > 0.3 | ((proband_tumor_vaf < 0.4 | proband_tumor_vaf > 0.6) & abs(loh_corrected) > 0.3)) %>%
  select(Hugo_Symbol, proband_germline_vaf, proband_tumor_vaf,
         loh_uncorrected, loh_corrected)


```


```{r}
loh_gene <- read_tsv(loh_gene_file) %>%
  filter(BS_ID_tumor %in% germline$Kids_First_Biospecimen_ID_tumor & gene %in% cpgs) %>%
  dplyr::rename(Kids_First_Biospecimen_ID_tumor = BS_ID_tumor,
                Hugo_Symbol = gene,
                gene_LOH_score_uncorrected = LOH_score_uncorrected) %>%
  select(Kids_First_Biospecimen_ID_tumor, Hugo_Symbol,
         gene_LOH_score_uncorrected)

germline_somatic_cnvs_loh_gene <- germline_somatic_cnvs_loh %>%
  left_join(loh_gene) %>%
  dplyr::mutate(gene_LOH_score_corrected = gene_LOH_score_uncorrected/tumor_fraction) %>%
  dplyr::mutate(gene_LOH_score_corrected = case_when(
    gene_LOH_score_corrected > 0.5 ~ 0.5,
    TRUE ~ gene_LOH_score_corrected
  ))


germline_somatic_cnvs_loh_gene %>%
  filter(gene_LOH_score_uncorrected > 0.3 | (gene_LOH_score_uncorrected > .1 & gene_LOH_score_corrected > 0.3)) %>%
  select(Hugo_Symbol, proband_germline_vaf, proband_tumor_vaf,
         loh_uncorrected, loh_corrected,
         gene_LOH_score_uncorrected,
         gene_LOH_score_corrected)

```
```{r}
germline_somatic_cnvs_loh_gene %>%
  filter(CNV_status_somatic != "neutral") %>%
  write_tsv(file.path(results_dir, "pbta-plp-cnv-somatic.tsv"))

germline_somatic_cnvs_loh_gene %>%
  filter(abs(loh_uncorrected) > 0.3 | ((proband_tumor_vaf < 0.4 | proband_tumor_vaf > 0.6) & abs(loh_corrected) > 0.3)) %>%
  write_tsv(file.path(results_dir, "pbta-plp-loh-somatic.tsv"))
```

merge CNV and LOH second hits and save output
```{r}
write_tsv(germline_somatic_cnvs_loh_gene,
          file.path(results_dir, "germline-somatic-cnv-loh.tsv"))
```
