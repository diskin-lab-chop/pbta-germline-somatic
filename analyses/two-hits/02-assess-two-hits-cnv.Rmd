---
title: "Assess somatic CNVs for second hits"
output: 
  html_notebook:
  toc: TRUE
toc_float: TRUE
author: Ryan Corbett
---

This analysis identifies patients with germline P-LP variants in cancer predisposition genes that show subsequent seconds CNV hits in tumors. 

### Set libraries and file paths

```{r load libraries}
# load libraries
library(tidyverse)

# define directories 
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
analysis_dir <- file.path(root_dir, "analyses", "two-hits")
input_dir <- file.path(analysis_dir, "input")
results_dir <- file.path(analysis_dir, "results")
data_dir <- file.path(root_dir, "data")

# If the input and results directories do not exist, create it
if (!dir.exists(results_dir)) {
  dir.create(results_dir, recursive = TRUE)
}

# germline P-LP calls 
plp_file <- file.path(data_dir, "pbta_germline_plp_calls.tsv")

# add histologies file 
histologies_file <- file.path(root_dir,"analyses", "collapse-tumor-histologies", "results", "germline-primary-plus-tumor-histologies-plot-groups-clin-meta.tsv")

# cnv file with annotation 
cnv_file <- file.path(data_dir, "consensus_seg_annotated_cn_autosomes.tsv.gz")

# loh file
loh_file <- file.path(input_dir, "pbta-plp-all-loh.tsv")

# cpg file
cpg_file <- file.path(root_dir, "analyses", "oncokb-annotation", "input", "cpg.txt")
```

Read in PLP, histology, and cpg files. Subset P-LP calls to CPGs only and add histology

```{r}
# rename columns to specify germline
germline <- read_tsv(plp_file) %>%
  dplyr::rename(Kids_First_Biospecimen_ID_normal = Kids_First_Biospecimen_ID,
                HGVSc_germ = HGVS.c,
                HGVSp_germ = HGVS.p) 

# renmae bs id column to match plp file
hist <- read_tsv(histologies_file)

# CPGs
cpgs <- read_lines(cpg_file)

# filter PLP calls and add plot_group and molecular_subtype
germline <- germline %>%
  filter(Hugo_Symbol %in% cpgs) %>%
  left_join(hist[,c("Kids_First_Biospecimen_ID_normal", "Kids_First_Biospecimen_ID_tumor",
                               "plot_group", "molecular_subtype")]) %>%
  select(Kids_First_Biospecimen_ID_normal, Kids_First_Biospecimen_ID_tumor, 
         plot_group, molecular_subtype,
         Hugo_Symbol, `L-LP_Call_final`, Reasoning_for_call,
         HGVSc_germ, HGVSp_germ)
```

Identify patients with germline PLP variant and somatic CNV in same CPG

```{r}
# filter cnv to patients in cohort and CPG calls only
cnv <- read_tsv(cnv_file) %>%
  filter(biospecimen_id %in% hist$Kids_First_Biospecimen_ID_tumor & gene_symbol %in% cpgs) %>%
  rename("Hugo_Symbol" = gene_symbol,
         "Kids_First_Biospecimen_ID_tumor" = biospecimen_id,
         "CNV_status_somatic" = status,
         "copy_number_somatic" = copy_number,
         "ploidy_somatic" = "ploidy") %>%
  select(Hugo_Symbol, Kids_First_Biospecimen_ID_tumor,
         CNV_status_somatic)

# merge germline SNV and somatic CNV calls by bs and gene id
germline_somatic_cnvs <- germline %>%
  inner_join(cnv, by = c("Kids_First_Biospecimen_ID_tumor", "Hugo_Symbol"))

germline_somatic_cnvs
```

Read in LOH results, and append LOH scores to rows of `germline_somatic_cnvs`

```{r}
loh <- read_tsv(loh_file)

germline_somatic_cnvs <- germline_somatic_cnvs %>%
  left_join(loh[,c("Kids_First_Biospecimen_ID_normal", "Hugo_Symbol", "LOH")], by = c("Kids_First_Biospecimen_ID_normal", "Hugo_Symbol"))
```

Identify patients with germline PLP and somatic LOH in same gene, but no CNV

```{r}
germline_somatic_loh <- germline %>%
  left_join(loh[,c("Kids_First_Biospecimen_ID_normal", "Hugo_Symbol", "LOH")], by = c("Kids_First_Biospecimen_ID_normal", "Hugo_Symbol")) %>%
  filter(LOH >= 0.3 & !Kids_First_Biospecimen_ID_normal %in% germline_somatic_gene_matches$Kids_First_Biospecimen_ID_normal) %>%
  mutate(CNV_status_somatic = "neutral") %>%
  relocate(LOH, .after = last_col())
```

merge CNV and LOH second hits and save output
```{r}
germline_somatic_cnv_loh <- germline_somatic_cnvs %>%
  bind_rows(germline_somatic_loh) %>%
  write_tsv(file.path(results_dir, "germline-somatic-cnv-loh-two-gene-hits.tsv"))
```
